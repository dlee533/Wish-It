<!DOCTYPE html>
<html lang="en">

<head>
    <title>Profile.html</title>
    <meta charset="utf-8">


    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Profile.html</title>
    <script src="https://www.gstatic.com/firebasejs/7.4.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.4.0/firebase-firestore.js"></script>
    <script src="firebaseConfig.js"></script>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>

    <link rel='stylesheet' type='text/css' href="mainCSS.css">
</head>

<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="main.html">WishIt</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarResponsive"
                aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarResponsive">
                <ul class="navbar-nav ml-auto">
                    <li class="nav-item active">
                        <a class="nav-link" id="myProfile">My Profile</a>
                    </li>
                    <li class="nav-item active">
                        <a class="nav-link" id="myFriends">Friends</a>
                    </li>
                    <li class="nav-item active">
                        <a class="nav-link signOut" href="index.html">Sign out</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- search bar-->
    <div class='container'></div>
    <div class="form-inline center col-12 col-md-10 col-lg-8">
        <select class="browser-default custom-select col-2 dropdownMenu" id="dropDownSelect">
            <option selected value="users">User</option>
            <option value="items">Item</option>
        </select>
        <input id="queryText" class="form-control col-8 search-bar" type="text" placeholder="Search"
            aria-label="Search">
        <button id="queryButton" type='submit' onclick="querySearch()" class='btn search-btn col-2'>Search</button>
    </div>
    </div>

    <!--user bio-->
    <div class="container col-12 col-md-10">
        <div class="card">
            <div class="card-body">
                <div class="row">
                    <img class="profileImage col-6 col-lg-3 center responsive" id="profilePhoto"
                        onclick="uploadProfilePhoto(this)">
                    <div class="container col-6">
                        <h3 class="name" id="displayName">Name</h3>
                        <p class="name" id="shortBio"></p>
                        <button class="btn followingStatus responsive">Wishlist</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- wishlist-->
    <div class="container col-12 col-md-10" id="start">
        <h1 class="display-3 wishList">Wish list</h1>
        <div class="cardContainer">
            <div class="card itemCard" value="notFilled">
                <!--clone this element with jquery and append to the end of closing div of class="card"-->
                <div class="card-body">
                    <div class="form-inline">
                        <input type="checkbox" class="itemCheck" style="visibility:hidden;">
                        <!-- initially set the raio button display to none-->
                        <!--set the value to the item name/other identificaftion-->
                        <div class="row">
                            <span class="itemName">Item Name</span>: $<span class="itemPrice">Item price</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <button class="btn submit" id="save" style="display:none;">Save</button>
        <!--with js, set the display of this element to none until
        'check off items' button clicked. -->
        <buttton class="btn" id="checkOffItems">Check off items</buttton>
        <!--onclick: set the display to none and
        display the save button+display the radio button on item cards-->
    </div>

    <script>
        let db = firebase.firestore();
        console.log("test ver 1.01");
        let queryStringURL = decodeURIComponent(window.location.search);
        let tempVar = queryStringURL.split('?');
        let uid = tempVar[1];
        console.log(uid, typeof (uid));
        //let userData;
        //let storage = firebase.storage().ref;

        function getUserData() {
            db.collection("users").doc(uid).get()
                .then(function (doc) {
                    if (doc.exists) {
                        console.log(doc.data());
                        updateElements(doc.data());
                    } else {
                        // doc.data() will be undefined in this case
                        console.log("No such document!");
                    }
                }).catch(function (error) {
                    console.log("Error getting document:", error);
                });
        }
        getUserData();
        let myWishList = [];    // store wishlistitem refs here
        function getUserWishList() {
            let displayWishListElem = document.getElementById("myWishList");
            

            
        }
        function updateElements(userData) {
            let wishListRef = db.collection("users").doc(uid).collction("wishlist");
            let displayNameElem = document.getElementById("displayName");
            displayNameElem.innerHTML = userData.name;
            let displayShortBioElem = document.getElementById("shortBio");
            displayShortBioElem.innerHTML = userData.short_bio; //to be updated to db once user sets one
            let displayProfilePhoto = document.getElementById("profilePhoto");
            displayProfilePhoto.setAttribute("SRC", userData.profile_photo); // to be updated on db storage once user uploads manually
            getUserWishList();
        }
        function uploadProfilePhoto(elem) {
        }
        function querySearch() {
            let selection = document.getElementById("dropDownSelect").value;
            //let btn = document.getElementById("queryButton");
            let query = document.getElementById("queryText").value;
            //btn.onclick = function() {
            window.location.href = "searchResult.html?" + selection + '=' + query;
            //}
        }
        // console.log(user.uid, localStorage.getItem('userId'));
        function myProfileDirect() {
            let my_profile = document.getElementById("myProfile");
            my_profile.onclick = function () {
                window.location.href = "profile.html?" + localStorage.getItem('userId');
            };
        }
        myProfileDirect();
        function myFriendsDirect() {
            let my_friends = document.getElementById("myFriends");
            my_friends.onclick = function () {
                window.location.href = "friendsList.html?" + localStorage.getItem('userId');
            };
        }
        myFriendsDirect();



        //wishlist
        function readWishlist() {
            db.collection("users").doc(uid).collection("wishlist").get()
                .then(function (querySnapshot) {
                    querySnapshot.forEach(function (doc) {
                        db.collection("items").doc(doc.id).get()
                            .then(function (itemDoc) {
                                createItem(itemDoc);
                            }).catch(function () {
                                console.log("Cannot find itemDoc")
                            })
                        console.log(doc.id, " => ", doc.data().itemRef);

                    });
                })
                .catch(function (error) {
                    console.log("Error getting documents: ", error);
                });
        }
        let itemCard = $(".itemCard").first();
        function createItem(item) {
            console.log(item.data()['price']);
            if (itemCard.last.value === "filled") {
                itemCard.clone().appendTo(".cardContainer");
                console.log(item.id)
                $("#start").find(".itemName:last").text(item.id);
                $("#start").find(".itemPrice:last").text(item.data()['price']);
                $("#start").find(".itemCheck:last").val(item.id);
            } else {
                console.log(item.id)
                itemCard.last.value = "filled";
                $("#start").find(".itemName").text(item.id);
                $("#start").find(".itemPrice").text(item.data()["price"]);
                $("#start").find(".itemCheck:last").val(item.id);
            }
        }
        readWishlist();



        //hide buttons
        function checkOnclickHandler() {
            //hide the checkOffItems btn
            document.getElementById("checkOffItems").style.display = "none";

            //display radio btn + save btn
            document.getElementById("save").style.display = "block";
            let items = document.querySelectorAll(".itemCheck");
            console.log(items);
            items.forEach(function (item) {
                item.style.cssText = "visibility:visible";
            });
        }

        function saveOnclickHandler() {
            //get the value of items in an array : jquery?
            let itemsToDelete = document.querySelectorAll("input:checked");
            console.log(itemsToDelete)
            //hide save btn +radio btn
            document.getElementById("save").style.display = "none";
            let items = document.querySelectorAll(".itemCheck");
            console.log(items);
            items.forEach(function (item) {
                item.style.cssText = "visibility:hidden";
            });
            //change the css of the items with value inside the jquery, or possibly delete them from database altogether
            removeItems(itemsToDelete);
            //display the checkOffItems btn         
            document.getElementById("checkOffItems").style.display = "inline";
        }

        function removeItems(itemArr) {
            itemArr.forEach(function (item) {
                db.collection("users").doc(uid).collection("wishlist").doc(item.value).delete().then(function () {
                    console.log(item.value, " deleted from ", uid);
                    $(item).closest(".itemCard").hide();
                }).catch(function (error) {
                    console.error("error removing document:", error);
                });
            });
        };
        document.getElementById("checkOffItems").onclick = checkOnclickHandler;
        document.getElementById("save").onclick = saveOnclickHandler;
    </script>
    <script src="signout.js"></script>
</body>

</html>