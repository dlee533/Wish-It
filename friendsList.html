<!DOCTYPE html>
<html lang="en">
<head>
    <title>friends list</title>
    <meta charset="utf-8">

    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>searchResult.html</title>
    <script src="https://www.gstatic.com/firebasejs/7.4.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.4.0/firebase-firestore.js"></script>
    <script src="firebaseConfig.js"></script>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>

    <link rel='stylesheet' type='text/css' href="mainCSS.css">

</head>

<body>

    <body>
        <!-- header -->
        <nav class="navbar navbar-expand-lg navbar-dark">
            <div class="container">
                <a class="navbar-brand" href="index.html">WishIt</a>
                <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarResponsive"
                    aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarResponsive">
                    <ul class="navbar-nav ml-auto">
                        <li class="nav-item active">
                            <a class="nav-link" href="#">My Profile</a>
                        </li>
                        <li class="nav-item active">
                            <a class="nav-link" href="#">Friends List</a>
                        </li>
                        <li class="nav-item active">
                            <a class="nav-link log">Sign out</a>
                    </ul>
                </div>
            </div>
        </nav><br>

        <!-- friends request -->
        <div class="jumbotron">
            <h1 class="display-3">Friends Request</h1>
            <div class="card col-6 col-lg-4" id="friendRequestBlock">
                <!--clone this level when adding more friends-->
                <div class="card-body">
                    <img src="images/profile_pic.png" alt="profile_pic" class="responsive">
                    <p class="friend_name">Name:</p>
                    <!--replace this with actual name-->
                    <button class="btn acceptRequest">Accept</button>
                </div>
            </div>
        </div>

        <!-- friends list -->
        <div class="jumbotron">
            <h1 class="display-3">Friends List</h1>
            <a class="friendsProfile" href="#">
                <!--href to profile with friends info-->
                <div class="card col-6 col-lg-4">
                    <!--clone this level when adding more friends-->
                    <div class="card-body">
                        <img src="images/profile_pic.png" alt="profile_pic" class="responsive">
                        <p class="friend_name">Name:</p>
                        <!--replace this with actual name-->
                    </div>
                </div>
            </a>
        </div>
    <script>
        let db = firebase.firestore();
        let uid = localStorage.getItem("userId");
        console.log(uid);
        function readRequests() {   //doc.id is other user's uid
            db.collection("users").doc(uid).collection("requests").get().then(function(querySnapshot) {
                querySnapshot.forEach(function(doc) {
                    let userRef = doc.data().userRef;
                    userDocRef(userRef);
                });
            });
        }
        readRequests();
        let friendRequestContainerElem = document.getElementById("friendRequestBlock");
        function userDocRef(userReference) {
            userReference.get().then(function(doc) {
                if (doc.exists) {
                    //console.log("Document data:", doc.data());
                    console.log("hello1");
                    let imgProfilePhotoElem = document.createElement("IMG");
                    let pNameElem = document.createElement("P");
                    let btnAcceptElem = document.createElement("BUTTON");
                    imgProfilePhotoElem.setAttribute("SRC", doc.data().profile_photo);
                    pNameElem.innerHTML = doc.data().name;
                    btnAcceptElem.innerHTML = "Accept";
                    btnAcceptElem.onclick = function() {
                        addFriendToFriendList(doc.id);  //add ref to friend user uid
                    }
                    friendRequestContainerElem.appendChild(imgProfilePhotoElem);
                    friendRequestContainerElem.appendChild(pNameElem);
                    friendRequestContainerElem.appendChild(btnAcceptElem);
                } else {
                    // doc.data() will be undefined in this case
                    console.log("No such document!");
                }
            }).catch(function(error) {
                console.log("Error getting document:", error);
            });
        }
        function addFriendToFriendList(frienduid) {
            db.collection("users").doc(uid).collection("friends list").doc(frienduid).set({
                userRef: db.doc("users/" + frienduid)
            });
        }
    </script>
    </body>
</html>