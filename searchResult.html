<!DOCTYPE html>
<html lang="en">

<head>
    <title>search result</title>
    <meta charset="utf-8">


    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>WishIt</title>
    <script src="https://www.gstatic.com/firebasejs/7.4.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.4.0/firebase-firestore.js"></script>
    <script src="firebaseConfig.js"></script>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>

    <link rel='stylesheet' type='text/css' href="mainCSS.css">

</head>

<body>

    <body>
        <!-- header -->
        <nav class="navbar navbar-expand-lg navbar-dark">
            <div class="container">
                <a class="navbar-brand" href="home.html">WishIt</a>
                <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarResponsive"
                    aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarResponsive">
                    <ul class="navbar-nav ml-auto">
                        <li class="nav-item active">
                            <a class="nav-link" id="myProfile">My Profile</a>
                        </li>
                        <li class="nav-item active">
                                <a class="nav-link" id="myFriends">Friends List</a>
                        </li>
                        <li class="nav-item active">
                            <a class="nav-link signOut" href="index.html">Log-out</a>
                            <!--change the text when the user signs in -->
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
        <!-- search bar-->
        <div class='container'></div>
        <div class="form-inline center col-12 col-md-10 col-lg-8">
            <select class="browser-default custom-select col-2 dropdownMenu" id="dropDownSelect">
                <option selected value="users">User</option>
                <option value="items">Item</option>
            </select>
            <input id="queryText" class="form-control col-8 search-bar" type="text" placeholder="Search"
                aria-label="Search">
            <button id="queryButton" type='submit' onclick="querySearch()" class='btn search-btn col-2'>Search</button>
        </div>
        </div>
        </nav>

        <!-- search result-->
        <div class="jumbotron">
            <div class="card col-12 col-lg-6">
                <div class="card-body">
                    <p class="result_info" id="resultInfoLabel">Results:</p>
                    <div class="result_list" id="results">
                        <!--create search block elements with JS-->

                    </div>
                </div>
            </div>


    </body>
    <script>
        console.log("test ver 1.01");
        let db = firebase.firestore();
        let queryStringURL = decodeURIComponent(window.location.search);
        let tempVar = queryStringURL.split('?');
        let passedValue = tempVar[1];
        tempVar = passedValue.split('=');
        let selectionType = String(tempVar[0].toLowerCase());
        let searchValue = String(tempVar[1].toUpperCase());
        let uid = localStorage.getItem("userId");
        console.log('HELLO', selectionType, typeof (selectionType), searchValue, typeof (searchValue));

        if (selectionType === "users") {
            console.log("here1");
            queryUsersResults();
        } else {
            queryItemsResults();
        }
        function queryUsersResults() {
            console.log("here2");
            db.collection("users").orderBy("name").startAt(searchValue).endAt(searchValue + '\uf8ff').limit(10).get().then(function (querySnapshot) {
                querySnapshot.forEach(function (doc) {
                    console.log(doc.id, doc.data());
                    createUserBlockResults(doc.id, doc.data());
                });
            });
        }
        function createUserBlockResults(frienduid, data) {
            console.log("here3");
            divElem = document.createElement("DIV");
            imgElem = document.createElement("IMG");
            pElemName = document.createElement("P");
            pElemBackground = document.createElement("P");
            parentDiv = document.getElementById("results");
            parentDiv.appendChild(divElem);
            divElem.appendChild(imgElem);
            divElem.appendChild(pElemName);
            divElem.appendChild(pElemBackground);

            addFriendBtnElem = document.createElement("BUTTON");
            addFriendBtnElem.innerHTML = "Add Friend";
            addFriendBtnElem.onclick = function() {
                //add to friend's friend request system (no need for requests on user)
                db.collection("users").doc(frienduid).collection("requests").doc(uid).set({
                    userRef: db.doc("users/" + uid)
                });
                addFriendBtnElem.innerHTML = "Added!";
            }
            divElem.appendChild(addFriendBtnElem);
            viewFriendBtnElem = document.createElement("BUTTON");
            viewFriendBtnElem.innerHTML = "View";
            viewFriendBtnElem.onclick = function() {
            //db.collection("users").doc(doc.id).get().then(function(doc) {
                window.location.href = "profile.html?" + frienduid;    
            }

            divElem.appendChild(viewFriendBtnElem);
            imgElem.setAttribute("SRC", data.profile_photo);    //to be added on user's profile page and update to db
            imgElem.setAttribute("WIDTH", 150 + 'px');        // to be edited with CSS; temporary here for testing
            pElemName.innerHTML = data.name;
            pElemBackground.innerHTML = data.short_bio;    //short bio (residence location, education background)
        }

        function queryItemsResults() {
            db.collection("items").orderBy('__name__').startAt(searchValue).endAt(searchValue + '\uf8ff').limit(10).get().then(function (querySnapshot) {
                querySnapshot.forEach(function (doc) {
                    console.log(doc.data());
                    createItemBlockResults(doc.id, doc.data());
                });
            });
        }
        function createItemBlockResults(name, data) {
            divElem = document.createElement("DIV");
            imgElem = document.createElement("IMG");
            pElemName = document.createElement("P");
            pElemPrice = document.createElement("P");

            parentDiv = document.getElementById("results");
            parentDiv.appendChild(divElem);
            divElem.appendChild(imgElem);
            divElem.appendChild(pElemName);
            divElem.appendChild(pElemPrice);
            imgElem.setAttribute("SRC", data.img_src);
            imgElem.setAttribute("WIDTH", 150 + 'px');        // to be edited with CSS; temporary here for testing
            pElemName.innerHTML = name;
            pElemPrice.innerHTML = '$' + data.price;
        }

        function querySearch() {
            let selection = document.getElementById("dropDownSelect").value;
            //let btn = document.getElementById("queryButton");
            let query = document.getElementById("queryText").value;
            //btn.onclick = function() {
            window.location.href = "searchResult.html?" + selection + '=' + query;
            //}
        }

        function myProfileDirect() {
            let my_profile = document.getElementById("myProfile");
            my_profile.onclick = function () {
                window.location.href = "profile.html?" + localStorage.getItem('userId');
            };
        }
        myProfileDirect();
        function myFriendsDirect() {
            let my_friends = document.getElementById("myFriends");
            my_friends.onclick = function () {
                window.location.href = "friendsList.html?" + localStorage.getItem('userId');
            };
        }
        myFriendsDirect();

    </script>
    <script src="signout.js"></script>
</body>
</html>