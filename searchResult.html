<!DOCTYPE html>
<html lang="en">

<head>
    <title>search result</title>
    <meta charset="utf-8">


    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>WishIt</title>
    <script src="https://www.gstatic.com/firebasejs/7.4.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.4.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.2.3/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.5.0/firebase-storage.js"></script>
    <script src="firebaseConfig.js"></script>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>

    <link rel='stylesheet' type='text/css' href="mainCSS.css">

</head>

<body>

    <body>
        <!-- header -->
        <nav class="navbar navbar-expand-lg navbar-dark">
            <div class="container">
                <a class="navbar-brand" href="main.html">WishIt</a>
                <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarResponsive"
                    aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarResponsive">
                    <ul class="navbar-nav ml-auto">
                        <li class="nav-item active">
                            <a class="nav-link" id="myProfile">My Profile</a>
                        </li>
                        <li class="nav-item active">
                                <a class="nav-link" id="myFriends">Friends List</a>
                        </li>
                        <li class="nav-item active">
                            <a class="nav-link signOut" id="signOut">Log-out</a>
                            <!--change the text when the user signs in -->
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        <!-- search bar-->
        <div class='container'></div>
        <div class="form-inline center col-12 col-md-10 col-lg-8">
            <select class="browser-default custom-select col-2 dropdownMenu" id="dropDownSelect">
                <option selected value="users">User</option>
                <option value="items">Item</option>
            </select>
            <input id="queryText" class="form-control col-8 search-bar" type="text" placeholder="Search"
                aria-label="Search">
            <button id="queryButton" type='submit' onclick="querySearch()" class='btn search-btn col-2'>Search</button>
        </div>
        </div>
        </nav>

        <!-- search result-->
        <div class="container">
            <div class="card col-12 col-lg-6">
                <div class="card-body">
                    <p class="result_info" id="resultInfoLabel">Results:</p>
                    <div id="addCustomItem">
                        <button data-toggle="collapse" data-target="#demo" onclick="editCollapsedContent()">Add custom item</button>
                        <div id="demo" class="collapse">
                            Item Name: <p id="customItemName"></p>
                            Item Price: <p id="customItemPrice"></p>
                            <input type="file" accept="image/*" onchange="openFile(event)" id="filetag">
                            <img id="customItemImg" />
                            <button id="saveBtn">Add item to my wishlist</button>
                        </div>
                </div id="parentDiv">
                    <div>
                    <div class="result_list row" id="results">
                        <!--create search block elements with JS-->

                    </div>
                </div>
                </div>
            </div>

    </body>
    <script>
        console.log("ver 3.01");
        let db = firebase.firestore();
        let queryStringURL = decodeURIComponent(window.location.search);
        let tempVar = queryStringURL.split('?');
        let passedValue = tempVar[1];
        tempVar = passedValue.split('=');
        let selectionType = String(tempVar[0].toLowerCase());
        let searchValue = String(tempVar[1].toUpperCase());
        let uid = localStorage.getItem("userId");
        //console.log('HELLO', selectionType, typeof (selectionType), searchValue, typeof (searchValue));
        let tempSplit = searchValue.split(' ');
        let keySearchValue = tempSplit[0].toLowerCase();
        let itemsRef = db.collection("items");
        if (selectionType === "users") {
            //console.log("here1");
            keySearchValue = keySearchValue.charAt(0).toUpperCase() + keySearchValue.slice(1);
            queryUsersResults();
        } else {
            queryItemsResults();
        }
        let temp;
        let userWishListRef = db.collection("users").doc(uid).collection("wishlist")
        function editCollapsedContent() {
            itemNameEditElem = document.getElementById("customItemName");
            itemPriceEditElem = document.getElementById("customItemPrice");
            itemNameEditElem.style.border = "solid black";
            itemPriceEditElem.style.border = "solid black";
            itemNameEditElem.setAttribute("contenteditable", "true");
            itemPriceEditElem.setAttribute("contenteditable", "true");
            saveBtnElem = document.getElementById("saveBtn");
            saveBtnElem.onclick = function() {
                console.log(itemNameEditElem.innerHTML);
                console.log(itemPriceEditElem.innerHTML);
            itemsRef.doc(itemNameEditElem.innerHTML).set({
                price: itemPriceEditElem.innerHTML,
                img_src: temp
            }).then(function() {
                console.log("Document successfully written!");
            })
            userWishListRef.doc(itemNameEditElem.innerHTML).set({
                itemRef: "items/" + itemNameEditElem.innerHTML
            }).then(function() {
                console.log("ItemRef Document successfully written!");
            })
        } 
        }
        let fileTag = document.getElementById("filetag");
        let preview = document.getElementById("customItemImg");
        preview.style.width = 400 + 'px';
        //console.log(uuidv4());
        
        let uniqueKey = uuidv4();
   
        let itemPhotoStorageRef = firebase.storage().ref("Custom Item Photos/" + uniqueKey);
        //let customToken = itemPhotoStorageRef.accessToken;
        function openFile(event) {
            let reader = new FileReader();
            let input = event.target;

            //if (input.files && input.files[0]) {
            //    reader = new FileReader();

                reader.onload = function() {
                    let dataURL = reader.result;
                    //store picture to db storage and set the new profile photo path to it
                    // here
                    // make sure user uploading file is it's own profile only
                    //console.log(dataURL);
                    //profilePhotoStorageRef.put(dataURL);
                    preview.setAttribute('src', dataURL);
                    temp = dataURL;
                }

                reader.readAsDataURL(input.files[0]);
                //temp = dataURL;
                //console.log(uid);
                
                itemPhotoStorageRef.put(input.files[0]);
                //console.log(input.files[0]);
        }
        function uuidv4() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
            var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
            });
        }
        function queryUsersResults() {
            db.collection("users").orderBy("name").startAt(keySearchValue).endAt(keySearchValue + '\uf8ff').limit(10).get().then(function (querySnapshot) {
                querySnapshot.forEach(function (doc) {
                    //console.log(doc.id, doc.data());
                    createUserBlockResults(doc.id, doc.data());
                });
            });
        }
        let parentDiv = document.getElementById("parentDiv");
        function createUserBlockResults(frienduid, data) {
            //console.log("here3");
            divElem = document.createElement("DIV");
            imgElem = document.createElement("IMG");
            pElemName = document.createElement("P");
            pElemBackground = document.createElement("P");
            parentDiv = document.getElementById("results");
            divElem.className = "jumbotron resultDiv";
            parentDiv.appendChild(divElem);
            divElem.appendChild(imgElem);
            divElem.appendChild(pElemName);
            divElem.appendChild(pElemBackground);

            addFriendBtnElem = document.createElement("BUTTON");
            addFriendBtnElem.innerHTML = "Add Friend";
            addFriendBtnElem.onclick = function() {
                //add to friend's friend request system (no need for requests on user)
                console.log("added test");
                db.collection("users").doc(frienduid).collection("requests").doc(uid).set({
                    userRef: db.doc("users/" + uid)
                });
                this.innerHTML = "Request sent!";

                setTimeout(function() {
                            parentDiv.removeChild(divElem);
                }, 1500);
            }
            divElem.appendChild(addFriendBtnElem);
            viewFriendBtnElem = document.createElement("BUTTON");
            viewFriendBtnElem.innerHTML = "View";
            viewFriendBtnElem.onclick = function() {
            //db.collection("users").doc(doc.id).get().then(function(doc) {
                window.location.href = "profile.html?" + frienduid;    
            }
            let profilePhotoStorageRef = firebase.storage().ref("Profile Photos/" + frienduid);
            divElem.appendChild(viewFriendBtnElem);
            //imgElem.setAttribute("SRC", data.profile_photo);    //to be added on user's profile page and update to db
            imgElem.setAttribute("WIDTH", 150 + 'px');        // to be edited with CSS; temporary here for testing
            pElemName.innerHTML = data.name;
            pElemBackground.innerHTML = data.short_bio;    //short bio (residence location, education background)
            profilePhotoStorageRef.getDownloadURL().then(function(url) {
            //get profile photo from storage
                var xhr = new XMLHttpRequest();
                xhr.responseType = 'blob';
                xhr.onload = function(event) {
                    var blob = xhr.response;
                };
                xhr.open('GET', url);
                //xhr.send();

                // Or inserted into an <img> element:
                
                imgElem.src = url;
                
                }).catch(function(error) {
                // Handle any errors
                imgElem.src = db.collection("users").doc(frienduid).profile_photo.get();
                });
        }
        
        function queryItemsResults() {
            db.collection("items").orderBy('__name__').startAt(keySearchValue).endAt(keySearchValue + '\uf8ff').limit(10).get().then(function (querySnapshot) {
                querySnapshot.forEach(function (doc) {
                    console.log(doc.data());
                    createItemBlockResults(doc.id, doc.data());
                });
            });
        }
        function createItemBlockResults(name, data) {
            divElem = document.createElement("DIV");
            imgElem = document.createElement("IMG");
            pElemName = document.createElement("P");
            pElemPrice = document.createElement("P");
            btnElemAddToWishList = document.createElement("BUTTON");
            btnElemAddToWishList.innerHTML = "Add to wishlist";
            parentDiv = document.getElementById("results");
            parentDiv.appendChild(divElem);
            divElem.appendChild(imgElem);
            divElem.appendChild(pElemName);
            divElem.appendChild(pElemPrice);
            divElem.appendChild(btnElemAddToWishList);
            btnElemAddToWishList.onclick = function() {
                userWishListRef.doc(pElemName.innerHTML).set({
              itemRef: db.doc("items/" + pElemName.innerHTML)
            });
            }
            imgElem.setAttribute("SRC", data.img_src);
            imgElem.setAttribute("WIDTH", 150 + 'px');        // to be edited with CSS; temporary here for testing
            pElemName.innerHTML = name;
            pElemPrice.innerHTML = '$' + data.price;
        }

        function querySearch() {
            let selection = document.getElementById("dropDownSelect").value;
            //let btn = document.getElementById("queryButton");
            let query = document.getElementById("queryText").value;
            //btn.onclick = function() {
            window.location.href = "searchResult.html?" + selection + '=' + query;
            //}
        }

        function myProfileDirect() {
            let my_profile = document.getElementById("myProfile");
            my_profile.onclick = function () {
                window.location.href = "profile.html?" + localStorage.getItem('userId');
            };
        }
        myProfileDirect();
        function myFriendsDirect() {
            let my_friends = document.getElementById("myFriends");
            my_friends.onclick = function () {
                window.location.href = "friendsList.html?" + localStorage.getItem('userId');
            };
        }
        myFriendsDirect();

    </script>
    <script src="signout.js"></script>
</body>
</html>