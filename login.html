<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Sign-in</title>

    <!--css stuff-->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
    <link rel='stylesheet' type='text/css' href="mainCSS.css">

    <!-- The core Firebase JS SDK is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/7.2.3/firebase-app.js"></script>


    <!-- TODO: Add SDKs for Firebase products that you want to use
        https://firebase.google.com/docs/web/setup#available-libraries -->
    <script src="https://www.gstatic.com/firebasejs/7.2.3/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.2.3/firebase-firestore.js"></script>


    <script>
        // Your web app's Firebase configuration
        var firebaseConfig = {
            apiKey: "AIzaSyCZJFlf1Q-uKORv49mZwHqKwYxjZMYpYxg",
            authDomain: "fir-f9d7a.firebaseapp.com",
            databaseURL: "https://fir-f9d7a.firebaseio.com",
            projectId: "fir-f9d7a",
            storageBucket: "fir-f9d7a.appspot.com",
            messagingSenderId: "526422688230",
            appId: "1:526422688230:web:a4c71e058f33d2fa30d627"
        };
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        
    </script>

    <script src="https://cdn.firebase.com/libs/firebaseui/3.5.2/firebaseui.js"></script>
    <link type="text/css" rel="stylesheet" href="https://cdn.firebase.com/libs/firebaseui/3.5.2/firebaseui.css" />

    <script>
        // Initialize the FirebaseUI Widget using Firebase.
        localStorage.clear();
        var db = firebase.firestore();
        console.log("test ver 1.01");
        var ui = new firebaseui.auth.AuthUI(firebase.auth());
        var uiConfig = {
  callbacks: {
    signInSuccessWithAuthResult: function(authResult, redirectUrl) {
      // User successfully signed in.
      // Return type determines whether we continue the redirect automatically
      // or whether we leave that to developer to handle.
      localStorage.setItem("userId", user.uid);
      console.log(localStorage.getItem("userId"));
      if (authResult.additionalUserInfo.isNewUser) {
          db.collection("users").doc(user.uid).collection("wishlist").doc("empty").set({
              
          });
          db.collection("users").doc(user.uid).set({
              display_name: user.displayName,
              name: user.displayName,
              email: user.email,
              short_bio: "Vancouver, BC, Canada",
              profile_photo: "https://firebasestorage.googleapis.com/v0/b/fir-f9d7a.appspot.com/o/Profile%20Photos%2Fdefault_profile_pic.jpeg?alt=media&token=804f3b39-a54e-4044-bb89-7948e994bc98"
          })
          .then(function () {
              window.location.assign('main.html');
          })
          .catch(function(error) {
              console.log("something bad happened");
          });
        }
        else 
        {
            return true;
        }
        return false
    },
    uiShown: function() {
      // The widget is rendered.
      // Hide the loader.
      document.getElementById('loader').style.display = 'none';
    }
  },
  // Will use popup for IDP Providers sign-in flow instead of the default, redirect.
  signInFlow: 'popup',
  signInSuccessUrl: 'main.html',
  signInOptions: [
    // Leave the lines as is for the providers you want to offer your users.
    firebase.auth.GoogleAuthProvider.PROVIDER_ID,
    firebase.auth.EmailAuthProvider.PROVIDER_ID,
  ],
  // Terms of service url.
  tosUrl: '<your-tos-url>',
  // Privacy policy url.
  privacyPolicyUrl: '<your-privacy-policy-url>'
};
var user = firebase.auth().currentUser
firebase.auth().onAuthStateChanged(function(user) {
  if (user) {
    // User is signed in.
    var display_name = user.displayName;
    var name = user.displayName;
    var email = user.email;
    var uid = user.uid;
    // ...
  } else {
    // User is signed out.
    // ...
  }
});
firebase.auth().setPersistence(firebase.auth.Auth.Persistence.SESSION)
  .then(function() {
    // Existing and future Auth states are now persisted in the current
    // session only. Closing the window would clear any existing state even
    // if a user forgets to sign out.
    // ...
    // New sign-in will be persisted with session persistence.
    return firebase.auth().signInWithEmailAndPassword(email, password);
  })
  .catch(function(error) {
    // Handle Errors here.
    var errorCode = error.code;
    var errorMessage = error.message;
  });

if (user != null) {
    var display_name = user.displayName;
    var name = user.displayName;
    var email = user.email;
    var uid = user.uid;
}
// The start method will wait until the DOM is loaded.
ui.start('#firebaseui-auth-container', uiConfig);
    </script>

</head>

<body>
    <!-- header -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="index.html">WishIt</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarResponsive"
                aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarResponsive">
                <ul class="navbar-nav ml-auto">
                    <li class="nav-item active">
                        <a class="nav-link" href="#">My Wishlist</a>
                    </li>
                    <li class="nav-item active">
                        <a class="nav-link" href="#">Friends</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>



    <!-- The surrounding HTML is left untouched by FirebaseUI.
        Your app may use that space for branding, controls and other customizations.-->
    <div id="firebaseui-auth-container"></div>
    <div id="loader">Loading...</div>


</body>

</html>
